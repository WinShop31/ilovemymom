, 210, 0.8);
    }

    .composer-textarea:focus {
      border-color: rgba(130, 87, 255, 0.95);
      box-shadow: 0 0 0 1px rgba(130, 87, 255, 0.8);
      background: radial-gradient(circle at 0 0, rgba(130,87,255,0.35), rgba(5,5,20,1));
      transform: translateY(-0.5px);
    }

    .composer-hints-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 11px;
      color: rgba(200, 201, 240, 0.8);
    }

    .composer-hints-row span.kbd {
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(5,5,20,0.9);
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      opacity: 0.9;
    }

    .composer-actions {
      display: flex;
      align-items: flex-end;
      gap: 6px;
    }

    .round-icon-btn {
      width: 34px;
      height: 34px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(6,6,24, 0.96);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: var(--text-soft);
      transition: transform var(--transition-fast), background var(--transition-fast),
        border-color var(--transition-fast), box-shadow var(--transition-fast), color var(--transition-fast);
      font-size: 17px;
    }

    .round-icon-btn:hover {
      transform: translateY(-1px);
      background: rgba(130,87,255,0.25);
      border-color: rgba(130,87,255,0.85);
      color: #fdfdff;
      box-shadow: 0 0 16px rgba(130,87,255,0.7);
    }

    .round-icon-btn:active {
      transform: translateY(0);
      box-shadow: 0 0 8px rgba(130,87,255,0.55);
    }

    .send-btn {
      min-width: 96px;
      padding: 0 16px;
      height: 36px;
      border-radius: 999px;
      border: none;
      background: radial-gradient(circle at 0 0, rgba(130,87,255,0.7), rgba(91, 141, 255, 0.98));
      color: #050511;
      font-weight: 600;
      font-size: 13px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      box-shadow: 0 0 22px rgba(130,87,255,0.8);
      transition: transform var(--transition-fast), box-shadow var(--transition-fast),
        filter var(--transition-fast), opacity var(--transition-fast), background-position 0.3s ease-out;
      background-size: 160% 160%;
      background-position: 0% 50%;
    }

    .send-btn span.icon {
      font-size: 14px;
      transform: translateY(-0.5px);
    }

    .send-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 0 28px rgba(130,87,255,1);
      filter: brightness(1.05);
      background-position: 100% 50%;
    }

    .send-btn:active {
      transform: translateY(0);
      box-shadow: 0 0 18px rgba(130,87,255,0.9);
      filter: brightness(0.97);
    }

    .send-btn[disabled] {
      opacity: 0.55;
      cursor: default;
      box-shadow: 0 0 8px rgba(130,87,255,0.4);
    }

    /* Toast */

    .toast {
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%) translateY(120%);
      padding: 8px 14px;
      border-radius: 999px;
      font-size: 13px;
      background: radial-gradient(circle at 0 0, rgba(255, 75, 129, 0.38), rgba(20, 4, 20, 0.98));
      border: 1px solid rgba(255, 75, 129, 0.9);
      color: #ffe9f3;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 0 24px rgba(255, 75, 129, 0.9);
      z-index: 100;
      transition: transform 0.26s ease-out, opacity 0.26s ease-out;
      opacity: 0;
      pointer-events: none;
    }

    .toast.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
      pointer-events: auto;
    }

    .toast-icon {
      font-size: 16px;
    }

    /* Responsive */

    @media (max-width: 900px) {
      body {
        padding: 8px;
      }

      .app-shell {
        max-height: none;
        height: 100%;
        border-radius: 22px;
      }

      .layout-main {
        padding: 8px;
        gap: 8px;
      }

      .sidebar {
        display: none;
      }

      .chat-pane {
        border-radius: 18px;
        padding: 8px 9px 10px 9px;
      }

      .app-header {
        padding: 10px 12px 8px 12px;
      }

      .brand-name {
        font-size: 15px;
      }

      .brand-subtitle {
        display: none;
      }

      .model-select-wrapper {
        padding: 4px 9px;
      }

      .model-label {
        display: none;
      }

      .messages-empty-title {
        font-size: 16px;
      }

      .messages-empty-subtitle {
        font-size: 12px;
      }

      .composer {
        padding: 7px 8px;
      }

      .composer-main {
        align-items: stretch;
      }

      .composer-actions {
        flex-direction: column;
        align-items: stretch;
      }

      .round-icon-btn {
        display: none;
      }

      .send-btn {
        width: 100%;
        justify-content: center;
      }

      .chat-pane-header-row {
        padding-bottom: 4px;
      }
    }

    @media (max-width: 600px) {
      .app-shell {
        border-radius: 0;
      }

      body {
        padding: 0;
      }
    }

    @media (prefers-reduced-motion: reduce) {
      * {
        scroll-behavior: auto !important;
        animation-duration: 0.001ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.001ms !important;
      }
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header class="app-header">
      <div class="brand">
        <div class="brand-logo"></div>
        <div class="brand-text">
          <div class="brand-name">Filsik AI Chat</div>
          <div class="brand-subtitle">Neon conversational intelligence</div>
        </div>
      </div>
      <div class="header-right">
        <div class="model-select-wrapper">
          <span class="model-label">–ú–æ–¥–µ–ª—å</span>
          <select id="modelSelect" class="model-select">
            <option value="yandex/aliceai-llm/latest">alice ¬∑ yandex/aliceai-llm/latest</option>
            <option value="cloudru/GigaChat/GigaChat-2-Max">gigachat ¬∑ GigaChat-2-Max</option>
            <option value="yandex/yandexgpt-lite/rc">yandexgpt-lite ¬∑ yandexgpt-lite/rc</option>
          </select>
          <span class="model-chip">
            <span class="status-dot"></span>
            live
          </span>
        </div>
      </div>
    </header>

    <main class="layout-main">
      <aside class="sidebar">
        <div class="sidebar-inner">
          <div class="sidebar-top">
            <button id="newChatBtn" class="new-chat-btn" type="button">
              <span class="icon">Ôºã</span>
              <span>–ù–æ–≤—ã–π –¥–∏–∞–ª–æ–≥</span>
            </button>
          </div>

          <div class="sidebar-model-pills" id="modelPills">
            <button class="model-pill active" data-model="yandex/aliceai-llm/latest" type="button">
              alice <span class="code"> ¬∑ aliceai</span>
            </button>
            <button class="model-pill" data-model="cloudru/GigaChat/GigaChat-2-Max" type="button">
              gigachat <span class="code"> ¬∑ g2</span>
            </button>
            <button class="model-pill" data-model="yandex/yandexgpt-lite/rc" type="button">
              yandexgpt-lite <span class="code"> ¬∑ rc</span>
            </button>
          </div>

          <div class="sidebar-divider"></div>

          <div class="sidebar-label-row">
            <span>–î–∏–∞–ª–æ–≥–∏</span>
            <span class="sidebar-label-right">Auto-save</span>
          </div>

          <div id="chatsList" class="chats-list"></div>

          <div class="sidebar-footer">
            <span><span class="tiny-dot"></span> –ò—Å—Ç–æ—Ä–∏—è –Ω–∞ —ç—Ç–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ</span>
            <span>v0.1 preview</span>
          </div>
        </div>
      </aside>

      <section class="chat-pane">
        <div class="chat-pane-inner">
          <div class="chat-pane-header-row">
            <div class="chat-session-title">
              <span id="activeChatTitle">–ù–æ–≤—ã–π –¥–∏–∞–ª–æ–≥</span>
              <span class="chat-session-pill" id="activeModelLabel">ALICE ¬∑ DEFAULT</span>
            </div>
            <div class="chat-pane-header-right">
              <span id="tokenUsageLabel">Session context</span>
              <div class="token-meter">
                <div class="token-bar">
                  <div class="token-bar-fill" id="tokenBarFill"></div>
                </div>
              </div>
            </div>
          </div>
          <div class="chat-pane-divider"></div>

          <div id="messagesArea" class="messages-area">
            <div class="messages-empty-state" id="emptyState">
              <div class="messages-empty-icon">
                <span>‚ú∂</span>
              </div>
              <div class="messages-empty-title">–°–ø—Ä–æ—Å–∏—Ç–µ Filsik AI –æ —á—ë–º —É–≥–æ–¥–Ω–æ</div>
              <div class="messages-empty-subtitle">
                –í—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥–µ–ª—å, –Ω–∞–ø–∏—à–∏—Ç–µ –∑–∞–ø—Ä–æ—Å –∏ –ø–æ–ª—É—á–∏—Ç–µ –æ—Ç–≤–µ—Ç –Ω–µ–π—Ä–æ—Å–µ—Ç–∏ –≤ –ø—Ä–µ–º–∏–∞–ª—å–Ω–æ–º –Ω–µ–æ–Ω–æ–≤–æ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ.
              </div>
              <div class="messages-empty-hints" id="emptyHints">
                <span data-text="–û–±—ä—è—Å–Ω–∏ –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏, –∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–µ–π—Ä–æ—Å–µ—Ç—å.">
                  –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–µ–π—Ä–æ—Å–µ—Ç—å?
                </span>
                <span data-text="–ü–æ–º–æ–≥–∏ –ø—Ä–∏–¥—É–º–∞—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –ª–µ–Ω–¥–∏–Ω–≥–∞ AI‚Äë—Å–µ—Ä–≤–∏—Å–∞.">
                  –£–Ω–∏–∫–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ª–µ–Ω–¥–∏–Ω–≥–∞
                </span>
                <span data-text="–°–æ—Å—Ç–∞–≤—å —Å–ø–∏—Å–æ–∫ –∏–¥–µ–π –¥–ª—è —Å–∞–π–¥‚Äë–ø—Ä–æ–µ–∫—Ç–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞.">
                  –ò–¥–µ–∏ —Å–∞–π–¥‚Äë–ø—Ä–æ–µ–∫—Ç–æ–≤
                </span>
              </div>
            </div>
          </div>

          <div class="composer">
            <div class="composer-top-row">
              <span>Prompt</span>
              <div class="composer-top-right">
                <span>Enter ‚èé ‚Äî –æ—Ç–ø—Ä–∞–≤–∏—Ç—å ¬∑ Shift+Enter ‚Äî –ø–µ—Ä–µ–Ω–æ—Å —Å—Ç—Ä–æ–∫–∏</span>
              </div>
            </div>
            <div class="composer-main">
              <div class="composer-input-wrapper">
                <textarea
                  id="messageInput"
                  class="composer-textarea"
                  rows="1"
                  placeholder="–°—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π—Ç–µ –∑–∞–ø—Ä–æ—Å –¥–ª—è Filsik AI‚Ä¶"
                ></textarea>
                <div class="composer-hints-row">
                  <span>–ù–µ —É–∫–∞–∑—ã–≤–∞–π—Ç–µ –ª–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö.</span>
                  <span class="kbd">‚èé –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏</span>
                </div>
              </div>
              <div class="composer-actions">
                <button class="round-icon-btn" type="button" id="clearChatBtn" title="–û—á–∏—Å—Ç–∏—Ç—å –¥–∏–∞–ª–æ–≥">
                  üßπ
                </button>
                <button class="send-btn" type="button" id="sendBtn">
                  <span class="icon">‚û§</span>
                  <span class="label">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</span>
                </button>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <div id="toast" class="toast">
    <span class="toast-icon">‚ö†Ô∏è</span>
    <span id="toastMessage"></span>
  </div>

  <script>
    (function () {
      const API_URL = "https://litellm.tokengate.ru/v1/chat/completions";
      const API_KEY = "sk-q9e9WNdWoZra6XgZfMKiOw";
      const DEFAULT_MODEL = "yandex/aliceai-llm/latest";

      const STORAGE_KEY = "filsik_ai_chat_sessions_v1";

      const modelSelect = document.getElementById("modelSelect");
      const messagesArea = document.getElementById("messagesArea");
      const messageInput = document.getElementById("messageInput");
      const sendBtn = document.getElementById("sendBtn");
      const clearChatBtn = document.getElementById("clearChatBtn");
      const newChatBtn = document.getElementById("newChatBtn");
      const chatsList = document.getElementById("chatsList");
      const activeChatTitle = document.getElementById("activeChatTitle");
      const activeModelLabel = document.getElementById("activeModelLabel");
      const emptystateEl = document.getElementById("emptyState");
      const emptyHints = document.getElementById("emptyHints");
      const tokenBarFill = document.getElementById("tokenBarFill");
      const tokenUsageLabel = document.getElementById("tokenUsageLabel");
      const modelPills = document.getElementById("modelPills");
      const toastEl = document.getElementById("toast");
      const toastMessageEl = document.getElementById("toastMessage");

      let sessions = {};
      let activeSessionId = null;
      let isSending = false;
      let toastTimeout = null;

      function generateId() {
        return (
          Date.now().toString(36) +
          "-" +
          Math.random().toString(36).substring(2, 8)
        );
      }

      function loadSessions() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (!raw) return {};
          const parsed = JSON.parse(raw);
          if (typeof parsed === "object" && parsed !== null) {
            return parsed;
          }
        } catch (e) {
          console.warn("Failed to load sessions from localStorage:", e);
        }
        return {};
      }

      function saveSessions() {
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(sessions));
        } catch (e) {
          console.warn("Failed to save sessions:", e);
        }
      }

      function createSession(initialModel) {
        const id = generateId();
        const session = {
          id,
          title: "–ù–æ–≤—ã–π –¥–∏–∞–ª–æ–≥",
          createdAt: Date.now(),
          updatedAt: Date.now(),
          model: initialModel || DEFAULT_MODEL,
          messages: []
        };
        sessions[id] = session;
        return session;
      }

      function getSession(id) {
        return sessions[id] || null;
      }

      function setActiveSession(id) {
        const session = getSession(id);
        if (!session) return;
        activeSessionId = id;
        updateActiveModelDisplay(session.model);
        renderChatSession(session);
        renderChatsList();
      }

      function updateSessionTitleFromFirstMessage(session) {
        if (!session || !session.messages || session.messages.length === 0) return;
        const firstUserMsg = session.messages.find(m => m.role === "user");
        if (!firstUserMsg || !firstUserMsg.content) return;
        const clean = firstUserMsg.content.replace(/\s+/g, " ").trim();
        if (!clean) return;
        const maxLen = 40;
        const title = clean.length > maxLen ? clean.slice(0, maxLen).trim() + "‚Ä¶" : clean;
        session.title = title;
      }

      function formatTime(timestamp) {
        const d = new Date(timestamp);
        if (Number.isNaN(d.getTime())) return "";
        const hours = String(d.getHours()).padStart(2, "0");
        const minutes = String(d.getMinutes()).padStart(2, "0");
        return hours + ":" + minutes;
      }

      function shortModelLabel(model) {
        switch (model) {
          case "yandex/aliceai-llm/latest":
            return "alice";
          case "cloudru/GigaChat/GigaChat-2-Max":
            return "gigachat";
          case "yandex/yandexgpt-lite/rc":
            return "yandexgpt-lite";
          default:
            return model;
        }
      }

      function updateActiveModelDisplay(model) {
        const short = shortModelLabel(model).toUpperCase();
        activeModelLabel.textContent = short + " ¬∑ " + model;
        let fill;
        if (model === "yandex/aliceai-llm/latest") fill = "45%";
        else if (model === "cloudru/GigaChat/GigaChat-2-Max") fill = "60%";
        else fill = "50%";
        tokenBarFill.style.width = fill;
        tokenUsageLabel.textContent = "Model: " + shortModelLabel(model);
      }

      function renderChatsList() {
        const sessionArray = Object.values(sessions).sort(
          (a, b) => b.updatedAt - a.updatedAt
        );
        chatsList.innerHTML = "";
        if (sessionArray.length === 0) {
          const placeholder = document.createElement("div");
          placeholder.style.fontSize = "12px";
          placeholder.style.color = "rgba(200,200,230,0.8)";
          placeholder.style.opacity = "0.9";
          placeholder.style.padding = "6px 4px";
          placeholder.textContent = "–ü–æ–∫–∞ –Ω–∏ –æ–¥–Ω–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π ‚Üí";
          chatsList.appendChild(placeholder);
          return;
        }
        sessionArray.forEach((session) => {
          const item = document.createElement("div");
          item.className = "chat-item" + (session.id === activeSessionId ? " active" : "");
          item.dataset.id = session.id;

          const titleRow = document.createElement("div");
          titleRow.className = "chat-title-row";

          const titleEl = document.createElement("div");
          titleEl.className = "chat-title";
          titleEl.textContent = session.title || "–ù–æ–≤—ã–π –¥–∏–∞–ª–æ–≥";

          const meta = document.createElement("div");
          meta.className = "chat-meta";

          const modelTag = document.createElement("span");
          modelTag.className = "chat-model-tag";
          modelTag.textContent = shortModelLabel(session.model);

          const timeEl = document.createElement("span");
          timeEl.className = "chat-time";
          timeEl.textContent = formatTime(session.updatedAt);

          meta.appendChild(modelTag);
          meta.appendChild(timeEl);

          titleRow.appendChild(titleEl);
          titleRow.appendChild(meta);

          const preview = document.createElement("div");
          preview.className = "chat-preview";
          const lastMsg = session.messages[session.messages.length - 1];
          preview.textContent = lastMsg ? lastMsg.content.slice(0, 60) : "–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –¥–∏–∞–ª–æ–≥";

          item.appendChild(titleRow);
          item.appendChild(preview);

          item.addEventListener("click", () => {
            setActiveSession(session.id);
          });

          chatsList.appendChild(item);
        });
      }

      function clearMessagesArea() {
        messagesArea.innerHTML = "";
      }

      function ensureEmptyState() {
        if (!emptystateEl.parentNode) {
          messagesArea.appendChild(emptystateEl);
        }
      }

      function hideEmptyState() {
        if (emptystateEl.parentNode) {
          emptystateEl.parentNode.removeChild(emptystateEl);
        }
      }

      function renderChatSession(session) {
        if (!session) return;
        activeChatTitle.textContent = session.title || "–ù–æ–≤—ã–π –¥–∏–∞–ª–æ–≥";
        modelSelect.value = session.model || DEFAULT_MODEL;

        Array.from(modelPills.querySelectorAll(".model-pill")).forEach(pill => {
          const pillModel = pill.getAttribute("data-model");
          pill.classList.toggle("active", pillModel === session.model);
        });

        clearMessagesArea();
        if (!session.messages || session.messages.length === 0) {
          ensureEmptyState();
          return;
        }
        hideEmptyState();
        session.messages.forEach((msg) => {
          appendMessageElement(msg);
        });
        scrollMessagesToBottom();
      }

      function appendMessageElement(message, isStreaming) {
        const wrap = document.createElement("div");
        wrap.className = "message " + (message.role === "user" ? "user" : "assistant");

        const avatar = document.createElement("div");
        avatar.className = "message-avatar";
        avatar.textContent = message.role === "user" ? "F" : "AI";

        const body = document.createElement("div");
        body.className = "message-body";

        const bubble = document.createElement("div");
        bubble.className = "message-bubble";
        bubble.textContent = message.content || "";

        const meta = document.createElement("div");
        meta.className = "message-meta";

        const time = document.createElement("span");
        time.textContent = formatTime(message.createdAt || Date.now());

        meta.appendChild(time);

        if (isStreaming) {
          const dotWrap = document.createElement("span");
          dotWrap.className = "message-loading";
          dotWrap.innerHTML = '<span>–ì–µ–Ω–µ—Ä–∞—Ü–∏—è</span><span class="dot"></span><span class="dot"></span><span class="dot"></span>';
          meta.appendChild(dotWrap);
          wrap.dataset.streaming = "true";
        }

        body.appendChild(bubble);
        body.appendChild(meta);
        wrap.appendChild(avatar);
        wrap.appendChild(body);
        messagesArea.appendChild(wrap);

        return { wrapper: wrap, bubble, meta };
      }

      function scrollMessagesToBottom() {
        messagesArea.scrollTop = messagesArea.scrollHeight;
      }

      function showToast(message) {
        toastMessageEl.textContent = message;
        toastEl.classList.add("show");
        if (toastTimeout) {
          clearTimeout(toastTimeout);
        }
        toastTimeout = setTimeout(() => {
          toastEl.classList.remove("show");
        }, 3200);
      }

      function updateSendState(sending) {
        isSending = sending;
        if (sending) {
          sendBtn.setAttribute("disabled", "true");
          sendBtn.querySelector(".label").textContent = "–ñ–¥—ë–º –æ—Ç–≤–µ—Ç‚Ä¶";
        } else {
          sendBtn.removeAttribute("disabled");
          sendBtn.querySelector(".label").textContent = "–û—Ç–ø—Ä–∞–≤–∏—Ç—å";
        }
      }

      function ensureActiveSession() {
        if (!activeSessionId || !getSession(activeSessionId)) {
          const session = createSession(modelSelect.value || DEFAULT_MODEL);
          activeSessionId = session.id;
        }
        return getSession(activeSessionId);
      }

      function updateSessionModelForActive(model) {
        const session = ensureActiveSession();
        if (session.model !== model) {
          session.model = model;
          session.updatedAt = Date.now();
          saveSessions();
          renderChatsList();
          updateActiveModelDisplay(model);
        }
      }

      function handleModelSelectChange() {
        const model = modelSelect.value || DEFAULT_MODEL;
        updateSessionModelForActive(model);

        Array.from(modelPills.querySelectorAll(".model-pill")).forEach(pill => {
          const pillModel = pill.getAttribute("data-model");
          pill.classList.toggle("active", pillModel === model);
        });
      }

      function handleModelPillClick(evt) {
        const button = evt.target.closest(".model-pill");
        if (!button) return;
        const model = button.getAttribute("data-model") || DEFAULT_MODEL;
        modelSelect.value = model;
        handleModelSelectChange();
      }

      function handleNewChat() {
        const model = modelSelect.value || DEFAULT_MODEL;
        const session = createSession(model);
        activeSessionId = session.id;
        saveSessions();
        renderChatsList();
        renderChatSession(session);
      }

      function handleEmptyHintClick(evt) {
        const hint = evt.target.closest("span[data-text]");
        if (!hint) return;
        const text = hint.getAttribute("data-text") || "";
        if (!text) return;
        messageInput.value = text;
        messageInput.focus();
        messageInput.setSelectionRange(text.length, text.length);
      }

      function handleClearChat() {
        const session = ensureActiveSession();
        if (!session) return;
        session.messages = [];
        session.updatedAt = Date.now();
        saveSessions();
        renderChatSession(session);
      }

      function estimateTokens(text) {
        if (!text) return 0;
        return Math.ceil(text.split(/\s+/).length * 1.3);
      }

      async function sendMessage() {
        if (isSending) return;
        const raw = messageInput.value;
        const content = raw.trim();
        if (!content) {
          showToast("–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏.");
          return;
        }

        const session = ensureActiveSession();
        const model = session.model || modelSelect.value || DEFAULT_MODEL;

        const createdAt = Date.now();
        const userMessage = {
          role: "user",
          content,
          createdAt
        };

        session.messages.push(userMessage);
        session.updatedAt = createdAt;
        updateSessionTitleFromFirstMessage(session);
        saveSessions();

        hideEmptyState();
        const userEl = appendMessageElement(userMessage);
        scrollMessagesToBottom();

        messageInput.value = "";
        updateSendState(true);

        const assistantMessage = {
          role: "assistant",
          content: "",
          createdAt: Date.now()
        };
        const assistantEl = appendMessageElement(assistantMessage, true);
        scrollMessagesToBottom();

        try {
          const response = await fetch(API_URL, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "Authorization": "Bearer " + API_KEY
            },
            body: JSON.stringify({
              model: model,
              messages: [
                { role: "user", content: content }
              ]
            })
          });

          let data;
          try {
            data = await response.json();
          } catch (jsonError) {
            console.error("Failed to parse JSON:", jsonError);
            throw new Error("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞.");
          }

          if (!response.ok) {
            console.error("API error:", response.status, data);
            throw new Error(data.error?.message || "–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ –º–æ–¥–µ–ª–∏.");
          }

          const contentFromAI = data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content
            ? data.choices[0].message.content
            : "(–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –æ—Ç –º–æ–¥–µ–ª–∏)";

          assistantMessage.content = contentFromAI;
          assistantMessage.createdAt = Date.now();
          session.messages.push(assistantMessage);
          session.updatedAt = assistantMessage.createdAt;

          const allText = session.messages.map(m => m.content).join(" ");
          const approxTokens = estimateTokens(allText);
          const maxTokens = 4000;
          const ratio = Math.min(1, approxTokens / maxTokens);
          const percent = Math.max(10, Math.round(ratio * 100));
          tokenBarFill.style.width = percent + "%";

          saveSessions();

          if (assistantEl.wrapper.dataset.streaming) {
            assistantEl.wrapper.dataset.streaming = "";
          }
          assistantEl.bubble.textContent = assistantMessage.content;
          const meta = assistantEl.meta;
          while (meta.firstChild) meta.removeChild(meta.firstChild);
          const time = document.createElement("span");
          time.textContent = formatTime(assistantMessage.createdAt);
          meta.appendChild(time);

          scrollMessagesToBottom();
          renderChatsList();
        } catch (error) {
          console.error("Send message failed:", error);
          showToast(error.message || "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç –º–æ–¥–µ–ª–∏.");
          assistantEl.bubble.textContent = "–û—à–∏–±–∫–∞: " + (error.message || "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞.");
          assistantEl.bubble.style.borderColor = "rgba(255, 75, 129, 0.9)";
          assistantEl.bubble.style.boxShadow = "0 0 18px rgba(255, 75, 129, 0.7)";
          const meta = assistantEl.meta;
          const errorTag = document.createElement("span");
          errorTag.textContent = "–æ—à–∏–±–∫–∞";
          errorTag.style.color = "#ffb3cf";
          const dot = document.createElement("span");
          dot.className = "message-meta-dot";
          const time = document.createElement("span");
          time.textContent = formatTime(Date.now());
          meta.
